version: "3.9"
services:
  redis-service:
    image: redis/redis-stack-server:latest
    container_name: redis-container
    environment:
      REDIS_ARGS: "--appendonly yes"

    volumes:
      - type: volume
        source: redis_data
        target: /data

    ports:
      - target: 6379
        published: 6379
        protocol: tcp
        mode: bridge

  api-app-service:
    container_name: api-app-container

    build:
      context: .

    ports:
      - target: 10080
        published: 10080
        protocol: tcp
        mode: bridge

    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.pepapi.rule=Host(`pepapi.sahl.solutions`)"
      - "traefik.http.routers.pepapi.entrypoints=secure"
      - "traefik.http.routers.pepapi.tls.certresolver=primary"

      - "traefik.http.routers.dashboard.rule=Host(`pepapi.sahl.solutions`) && (PathPrefix(`/api`) || PathPrefix(`/dashboard`))"
      - "traefik.http.routers.dashboard.tls.certresolver=primary"
      - "traefik.http.routers.dashboard.service=api@internal"

    restart: unless-stopped

    depends_on:
      - redis-service


  traefik-service:
    container_name: traefik-container
    image: traefik:latest

    ports:
      - target: 80
        published: 80
        protocol: tcp
        mode: bridge

      - target: 443
        published: 443
        protocol: tcp
        mode: bridge

      - target: 8080
        published: 8080
        protocol: tcp
        mode: bridge

    volumes:
      - /run/docker.sock:/var/run/docker.sock:ro
      - "/letsencrypt:/letsencrypt"

    environment:
      TRAEFIK_ENTRYPOINTS_UNSECURE: "true"
      TRAEFIK_ENTRYPOINTS_UNSECURE_ADDRESS: :80

      TRAEFIK_ENTRYPOINTS_UNSECURE_HTTP_REDIRECTIONS_ENTRYPOINT_TO: "secure"
      TRAEFIK_ENTRYPOINTS_UNSECURE_HTTP_REDIRECTIONS_ENTRYPOINT_PERMANENT: "true"
      TRAEFIK_ENTRYPOINTS_UNSECURE_HTTP_REDIRECTIONS_ENTRYPOINT_SCHEME: "https"
      TRAEFIK_ENTRYPOINTS_SECURE: "true"
      TRAEFIK_ENTRYPOINTS_SECURE_ADDRESS: :443

      TRAEFIK_PROVIDERS_DOCKER: "true"
      TRAEFIK_PROVIDERS_DOCKER_EXPOSEDBYDEFAULT: "false"

      # TRAEFIK_API: "true"
      TRAEFIK_API_DASHBOARD: "true"
      # TRAEFIK_API_INSECURE: "false"

      TRAEFIK_CERTIFICATESRESOLVERS_PRIMARY: "true"
      TRAEFIK_CERTIFICATESRESOLVERS_PRIMARY_ACME_EMAIL: "anjum@sahl.solutions"
      TRAEFIK_CERTIFICATESRESOLVERS_PRIMARY_ACME_TLSCHALLENGE: "true"
      TRAEFIK_CERTIFICATESRESOLVERS_PRIMARY_ACME_STORAGE: /letsencrypt/acme.json

      TRAEFIK_CERTIFICATESRESOLVERS_PRIMARY_ACME_CASERVER: "https://acme-staging-v02.api.letsencrypt.org/directory"

      TRAEFIK_LOG: "true"
      TRAEFIK_LOG_LEVEL: "DEBUG"
      TRAEFIK_LOG_FILEPATH: "/var/log/traefik-logs.log"
      TRAEFIK_LOG_FORMAT: "json"

networks:
  webapp:

volumes:
  redis_data:
    driver: local
